@model PaginationResult<WebBanMayTinh.Models.Order>

@{
    ViewData["Title"] = "Danh sách đơn hàng";
    Layout = "~/Areas/Admin/Views/Shared/_Layout.cshtml";

    var count = 0;
    // var pager = ViewBag.Pagination as PaginationResult;
}

@if (TempData["Success"] != null && TempData["Error"] == null)
{
    <div class="alert alert-success">@TempData["Success"]</div>
}
@if (TempData["Error"] != null && TempData["Success"] == null)
{
    <div class="alert alert-danger">@TempData["Error"]</div>
}

<h2 class="text-center">Danh sách đơn hàng</h2>
<form asp-action="Index" method="get" class="mb-3">
    <div class="row g-2">

        <!-- Trạng thái -->
        <div class="col-md-2">
            <label class="form-label">Trạng thái</label>
            <select name="Status" class="form-select">
                <option value="">-- Tất cả --</option>
                @foreach (OrderStatus s in Enum.GetValues(typeof(OrderStatus)))
                {
                    <option value="@((int)s)" selected="@(ViewBag.StatusFrom != null && (int)s == ViewBag.StatusFrom)">
                        @OrderStatusExtensions.ToVietNamText(s)
                    </option>
                }
            </select>
        </div>

        <!-- Thời gian từ -->
        <div class="col-md-2">
            <label class="form-label">Từ ngày</label>
            <input type="date" name="FromDate" value="@ViewBag.FromDate" class="form-control" />
        </div>

        <!-- Thời gian đến -->
        <div class="col-md-2">
            <label class="form-label">Đến ngày</label>
            <input type="date" name="ToDate" value="@ViewBag.ToDate" class="form-control" />
        </div>

        <!-- Tài khoản -->
        <div class="col-md-2">
            <label class="form-label">Tài khoản</label>
            <input type="text" name="UserName" value="@ViewBag.UserName" class="form-control" />
        </div>

        <!-- Tổng tiền từ -->
        <div class="col-md-2">
            <label class="form-label">Tiền từ</label>
            <input type="number" name="TotalFrom" value="@ViewBag.TotalFrom" class="form-control" />
        </div>

        <!-- Tổng tiền đến -->
        <div class="col-md-2">
            <label class="form-label">Tiền đến</label>
            <input type="number" name="TotalTo" value="@ViewBag.TotalTo" class="form-control" />
        </div>

        <!-- Nút tìm -->
        <div class="col-md-12 text-end">
            <button type="submit" class="btn btn-primary mt-2">
                <i class="bx bx-search"></i> Tìm kiếm
            </button>
            <a asp-action="Index" class="btn btn-secondary mt-2">
                <i class="bx bx-reset"></i> Reset
            </a>
        </div>
    </div>
</form>
<div class="card">
    <div class="card-body">
        <table class="table">
            <thead>
                <tr>
                    <th>#</th>
                    <th>
                        Thời gian
                    </th>
                    <th>
                        Trạng thái
                    </th>
                    <th>
                        Tiền hàng
                    </th>
                    <th>
                        Phí ship
                    </th>
                    <th>
                        Tổng tiền
                    </th>
                    <th>
                        Tài khoản đặt hàng
                    </th>
                    <th>
                        Địa chỉ nhận
                    </th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model.Items)
                {
                    count += 1;
                    <tr class="@(item.IsCancelRequested == true ? "text-danger" : "")">
                        <td>@count</td>
                        <td>
                            @Html.DisplayFor(modelItem => item.CreatedAt)
                        </td>
                        <td class="@OrderStatusExtensions.ToTextColor(item.Status)">
                            @OrderStatusExtensions.ToVietNamText(item.Status)
                        </td>
                        <td class="text-nowrap">
                            @CurrencyExtensions.ToVnd(item.Subtotal)
                        </td>
                        <td class="text-nowrap">
                            @CurrencyExtensions.ToVnd(item.ShippingFee)
                        </td>
                        <td class="text-nowrap">
                            @CurrencyExtensions.ToVnd(item.TotalAmount)
                        </td>
                        <td>
                            @Html.DisplayFor(modelItem => item.User.UserName)
                        </td>
                        <td>
                            @Html.DisplayFor(modelItem => item.Address.Province)
                        </td>
                        <td class="text-nowrap">
                            <div class="dropdown position-static">
                                <button type="button" class="btn btn-primary btn-icon rounded-pill dropdown-toggle hide-arrow" data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="icon-base bx bx-dots-vertical-rounded"></i>
                                </button>
                                <ul class="dropdown-menu" style="">
                                    @if (item.Status != OrderStatus.Cancelled)
                                    {
                                        <li><a class="dropdown-item" asp-action="Edit" asp-route-id="@item.Id"><i class='bx  bx-edit'></i> Cập nhật trạng thái </a> </li>
                                    }
                                    <li><a class="dropdown-item" asp-action="Details" asp-route-id="@item.Id"><i class='bx bx-detail me-1'></i> Chi tiết </a> </li>
                                    @if (item.IsCancelRequested && item.Status != OrderStatus.Cancelled)
                                    {
                                        <li class="cursor-pointer">
                                            @* <form asp-action="ConfirmCancelRequest" method="post">
                                                <input type="hidden" name="id" value="@item.Id" />
                                                <button role="button" class="dropdown-item"><i class='bx bx-x'></i> Xác nhận hủy đơn hàng </button>
                                            </form> *@
                                            <a class="dropdown-item" asp-route-id="@item.Id" asp-action="CancelRequest"><i class='bx bx-x'></i> Xác nhận hủy đơn hàng</a>
                                        </li>
                                    }
                                    <li><a class="dropdown-item" asp-action="Delete" asp-route-id="@item.Id"><i class='bx  bx-trash'></i> Xóa </a> </li>
                                    @* <li><a class="dropdown-item " asp-action="Permission" asp-route-id="@i.Id"><i class="bx bx-user me-1"></i> Phân quyền</a></li> *@
                                </ul>
                                <div class="dropdown-menu">
                                </div>
                            </div>

                        </td>
                    </tr>
                }
            </tbody>
        </table>
    
        @if (Model.TotalPages > 1)
        {
            <div class="d-flex justify-content-center">
                <ul class="pagination mt-2">

                    <li class="page-item @(Model.HasPrevious ? "" : "disabled")">
                        <a class="page-link"
                           asp-route-page="@(Model.CurrentPage - 1)"
                           asp-route-StatusFrom="@ViewBag.Status"
                           asp-route-FromDate="@ViewBag.FromDate"
                           asp-route-ToDate="@ViewBag.ToDate"
                           asp-route-UserName="@ViewBag.UserName"
                           asp-route-TotalFrom="@ViewBag.TotalFrom"
                           asp-route-TotalTo="@ViewBag.TotalTo">‹</a>
                    </li>

                    @foreach (var p in Model.GetPages())
                    {
                        if (p.IsEllipsis)
                        {
                            <li class="page-item disabled">
                                <span class="page-link">...</span>
                            </li>
                        }
                        else
                        {
                            <li class="page-item @(p.IsActive ? "active" : "")">
                                <a class="page-link"
                                   asp-route-page="@p.PageNumber"
                                   asp-route-StatusFrom="@ViewBag.Status"
                                   asp-route-FromDate="@ViewBag.FromDate"
                                   asp-route-ToDate="@ViewBag.ToDate"
                                   asp-route-UserName="@ViewBag.UserName"
                                   asp-route-TotalFrom="@ViewBag.TotalFrom"
                                   asp-route-TotalTo="@ViewBag.TotalTo">
                                    @p.PageNumber
                                </a>
                            </li>
                        }
                    }

                    <li class="page-item @(Model.HasNext ? "" : "disabled")">
                        <a class="page-link"
                           asp-route-page="@(Model.CurrentPage + 1)"
                           asp-route-StatusFrom="@ViewBag.Status"
                           asp-route-FromDate="@ViewBag.FromDate"
                           asp-route-ToDate="@ViewBag.ToDate"
                           asp-route-UserName="@ViewBag.UserName"
                           asp-route-TotalFrom="@ViewBag.TotalFrom"
                           asp-route-TotalTo="@ViewBag.TotalTo">›</a>
                    </li>

                </ul>
            </div>
        }
    </div>
</div>
